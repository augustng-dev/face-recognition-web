<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Q100 | AkaCam/QAI/FPT Software</title>
  <link rel="icon" type="image/png" href="./assets/img/favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/selecto@1.26.2/dist/selecto.min.js"></script>
</head>
<body class="p-4 sm:p-6 bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="p-4 mb-4 bg-white shadow rounded-lg">
    <div class="flex flex-col sm:flex-row justify-between items-center">
      <img src="./assets/img/logo_fpt_text_black.webp" alt="FPT Logo" class="h-10 sm:h-12 mb-2 sm:mb-0" />
      <img src="./assets/img/akacam-logo.png" alt="AkaCam Logo" class="h-10 sm:h-12" />
    </div>
  </header>

  <!-- Main Content -->
  <div class="container mx-auto">
    <div class="border-b border-gray-300 mb-4 w-full"></div>
    <h1 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">Bảng dữ liệu</h1>

    <!-- Search and Add Button -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
      <form class="w-full sm:w-auto max-w-md">
        <label for="default-search" class="sr-only">Tìm kiếm</label>
        <div class="relative">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="search" id="default-search" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500" placeholder="Tìm kiếm..." required />
          <button type="submit" class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-3 sm:px-4 py-2">Tìm kiếm</button>
        </div>
      </form>
      <button type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 sm:px-5 py-2.5 w-full sm:w-auto" data-action="add">Thêm</button>
    </div>

    <!-- Table -->
    <div class="relative overflow-x-auto sm:rounded-lg bg-white shadow">
      <table class="w-full text-sm text-left text-gray-500">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th scope="col" class="px-4 sm:px-6 py-3">ID</th>
            <th scope="col" class="px-4 sm:px-6 py-3">Họ và tên</th>
            <th scope="col" class="px-4 sm:px-6 py-3">Ảnh</th>
            <th scope="col" class="px-4 sm:px-6 py-3">Hành động</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <nav class="flex flex-col sm:flex-row items-center justify-between p-4" aria-label="Table navigation">
        <span class="text-sm font-normal text-gray-500 mb-4 sm:mb-0 w-full sm:w-auto text-center sm:text-left">
          Showing <span id="startRecord"></span> - <span id="endRecord"></span> of <span id="totalRecords"></span>
        </span>
        <ul id="pagination" class="inline-flex -space-x-px text-sm h-8 flex-wrap justify-center cursor-pointer"></ul>
      </nav>
    </div>

    <!-- CRUD Modal -->
    <div id="crudModal" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center z-50">
      <div id="modalOverlay" class="fixed inset-0 bg-gray-600 opacity-50"></div>
      <div class="relative bg-white rounded-lg shadow w-full sm:w-3/4 max-h-[90vh] overflow-y-auto mx-4 sm:mx-0">
        <div class="flex items-center justify-between p-5 border-b rounded-t">
          <h3 id="modalTitle" class="text-lg sm:text-xl font-semibold text-gray-900">Thêm/Sửa</h3>
          <button type="button" class="text-gray-400 hover:bg-gray-200 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center" data-close>
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
          </button>
        </div>
        <div class="p-5 space-y-4">
          <input type="hidden" id="editId" />
          <div class="flex flex-col sm:flex-row gap-4 h-auto sm:h-96">
            <div class="w-full sm:w-1/2 min-h-[200px] ">
              <div class="border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center p-6 sm:p-10 cursor-pointer w-full relative" id="dropzone">
              <div class="text-gray-500 text-center" id="placeholderText">Kéo & thả tệp vào đây hoặc bấm để tải lên</div>
              <input type="file" id="fileInput" class="hidden" accept="image/*" multiple />
              <div id="imagePreview" class="grid grid-cols-2 sm:grid-cols-3 gap-4 hidden overflow-auto w-full"></div>
              <button id="deleteSelected" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hidden">Xóa đã chọn</button>
              <div id="loadingSpinner" class="absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
              </div>
              </div>
              <button id="deleteAll" class="mt-4 bg-red-600 text-white px-4 py-2 rounded hidden">Xóa tất cả</button>
            </div>
            <fieldset class="border border-gray-300 rounded-lg p-4 w-full sm:w-1/2">
              <legend class="text-base sm:text-lg font-medium mb-2">Thông tin</legend>
              <label class="block mb-2 text-gray-700">Tên:</label>
              <input type="text" id="nameInput" class="border border-gray-300 p-2 w-full rounded mb-4 focus:ring-blue-500 focus:border-blue-500" placeholder="Nhập tên" />
            </fieldset>
          </div>
        </div>
        <div class="flex items-center p-5 border-t">
          <button id="saveButton" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 w-full">Lưu</button>
        </div>
      </div>
    </div>

    <!-- Dropzone Overlay -->
    <div id="dropzone-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="w-full h-full flex flex-col items-center justify-center border-2 border-dashed border-white bg-gray-700 bg-opacity-75 text-white text-lg font-bold">
        Kéo & thả tệp vào đây
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-lg w-full sm:w-[95vw] h-[90vh] flex flex-col">
        <div class="flex justify-between p-4 border-b">
          <h3 class="text-xl font-semibold">Xem ảnh</h3>
          <button id="closeImageModal" class="text-gray-500 hover:text-gray-700">×</button>
        </div>
        <div class="flex-1 p-4 overflow-auto flex items-center justify-center">
          <img id="modalImage" class="max-w-full max-h-full mx-auto hidden" />
        </div>
        <div class="p-4 border-t flex justify-end gap-2">
          <button class="bg-blue-500 text-white px-4 py-2 rounded" data-rotate="-90">↺</button>
          <button class="bg-blue-500 text-white px-4 py-2 rounded" data-rotate="90">↻</button>
          <button class="bg-blue-500 text-white px-4 py-2 rounded" data-flip>⟷</button>
          <button class="bg-blue-500 text-white px-4 py-2 rounded" data-zoom="1.1">+</button>
          <button class="bg-blue-500 text-white px-4 py-2 rounded" data-zoom="0.9">-</button>
          <button class="bg-green-500 text-white px-4 py-2 rounded" data-download>Tải xuống</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    function dataURItoBlob(dataURI) {
      const [header, data] = dataURI.split(',');
      const mime = header.match(/:(.*?);/)[1];
      const binary = atob(data);
      const array = [];
      for (let i = 0; i < binary.length; i++) array.push(binary.charCodeAt(i));
      return new Blob([new Uint8Array(array)], { type: mime });
    }

    const state = {
      data: [],
      currentPage: 1,
      rowsPerPage: 5,
      modalMode: 'add',
      imageState: { rotation: 0, scale: 1, flipped: false }
    };

    const elements = {
      tableBody: document.getElementById('tableBody'),
      pagination: document.getElementById('pagination'),
      startRecord: document.getElementById('startRecord'),
      endRecord: document.getElementById('endRecord'),
      totalRecords: document.getElementById('totalRecords'),
      searchInput: document.getElementById('default-search'),
      crudModal: document.getElementById('crudModal'),
      modalTitle: document.getElementById('modalTitle'),
      saveButton: document.getElementById('saveButton'),
      nameInput: document.getElementById('nameInput'),
      editId: document.getElementById('editId'),
      dropzone: document.getElementById('dropzone'),
      fileInput: document.getElementById('fileInput'),
      imagePreview: document.getElementById('imagePreview'),
      placeholderText: document.getElementById('placeholderText'),
      loadingSpinner: document.getElementById('loadingSpinner'),
      dropzoneOverlay: document.getElementById('dropzone-overlay'),
      imageModal: document.getElementById('imageModal'),
      modalImage: document.getElementById('modalImage'),
      deleteSelected: document.getElementById('deleteSelected'),
      deleteAll: document.getElementById('deleteAll'),
      closeImageModal: document.getElementById('closeImageModal')
    };

    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    };

    const fetchData = async () => {
      try {
        const response = await fetch('https://dummyjson.com/users');
        if (!response.ok) throw new Error('Không thể tải dữ liệu');
        const json = await response.json();
        state.data = json.users.map(user => ({
          id: user.id,
          name: `${user.firstName} ${user.lastName}`,
          image: user.image
        }));
        renderTable();
      } catch (error) {
        console.error('Lỗi khi tải dữ liệu:', error);
        alert('Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.');
      }
    };

    const getFilteredData = () => {
      const query = elements.searchInput.value.toLowerCase();
      return state.data.filter(item => item.name.toLowerCase().includes(query));
    };

    const renderTable = () => {
      const filteredData = getFilteredData();
      const totalRecords = filteredData.length;
      const startIndex = (state.currentPage - 1) * state.rowsPerPage;
      const paginatedData = filteredData.slice(startIndex, startIndex + state.rowsPerPage);

      elements.tableBody.innerHTML = '';
      if (filteredData.length === 0) {
        elements.tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-8">Không tìm thấy kết quả</td></tr>';
      } else {
        const fragment = document.createDocumentFragment();
        paginatedData.forEach(item => {
          const tr = document.createElement('tr');
          tr.className = 'bg-white border-b hover:bg-gray-50';
          tr.innerHTML = `
            <th scope="row" class="px-4 sm:px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.id}</th>
            <td class="px-4 sm:px-6 py-4">${item.name}</td>
            <td class="px-4 sm:px-6 py-4">
              <img src="${item.image}" alt="${item.name}" class="h-10 w-10 object-cover rounded-full cursor-pointer transform transition-transform duration-300 hover:scale-150" onclick="openImageModal('${item.image}')">
            </td>
            <td class="px-4 sm:px-6 py-4 flex gap-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm" data-edit="${item.id},${item.name},${item.image}">Sửa</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded text-sm" data-delete="${item.id}">Xóa</button>
            </td>`;
          fragment.appendChild(tr);
        });
        elements.tableBody.appendChild(fragment);
      }

      elements.startRecord.textContent = totalRecords > 0 ? startIndex + 1 : 0;
      elements.endRecord.textContent = Math.min(startIndex + state.rowsPerPage, totalRecords);
      elements.totalRecords.textContent = totalRecords;
      renderPagination(totalRecords);
    };

    const renderPagination = (totalRecords) => {
      const totalPages = Math.ceil(totalRecords / state.rowsPerPage);
      elements.pagination.innerHTML = '';
      const fragment = document.createDocumentFragment();

      fragment.appendChild(createPaginationItem(state.currentPage === 1, 'Trước', prevPage));
      for (let i = 1; i <= totalPages; i++) {
        fragment.appendChild(createPaginationItem(
          state.currentPage === i,
          i,
          () => goToPage(i),
          state.currentPage === i ? 'text-blue-600 bg-blue-50' : 'bg-white hover:bg-gray-100 hover:text-gray-700'
        ));
      }
      fragment.appendChild(createPaginationItem(state.currentPage === totalPages, 'Sau', nextPage));
      elements.pagination.appendChild(fragment);
    };

    const createPaginationItem = (isDisabled, text, onClick, extraClass = '') => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.textContent = text;
      a.className = `px-3 py-2 flex items-center justify-center border border-gray-300 rounded-lg mx-1 text-sm ${extraClass}`;
      if (isDisabled) a.className += ' cursor-not-allowed opacity-50 bg-gray-200 text-gray-400';
      else a.addEventListener('click', onClick);
      li.appendChild(a);
      return li;
    };

    const prevPage = () => { if (state.currentPage > 1) { state.currentPage--; renderTable(); } };
    const nextPage = () => {
      const totalPages = Math.ceil(getFilteredData().length / state.rowsPerPage);
      if (state.currentPage < totalPages) { state.currentPage++; renderTable(); }
    };
    const goToPage = (page) => { state.currentPage = page; renderTable(); };

    const openModal = (mode, id = null, name = '', image = '') => {
      state.modalMode = mode;
      elements.modalTitle.textContent = mode === 'add' ? 'Thêm dữ liệu' : 'Sửa dữ liệu';
      elements.saveButton.textContent = mode === 'add' ? 'Thêm' : 'Lưu';
      elements.nameInput.value = name;
      elements.editId.value = id || '';
      elements.imagePreview.innerHTML = '';
      if (image) {
        const wrapper = document.createElement('div');
        wrapper.className = 'relative aspect-square';
        const img = document.createElement('img');
        img.src = image;
        img.className = 'h-full w-full rounded-lg object-cover cursor-pointer';
        wrapper.appendChild(img);
        elements.imagePreview.appendChild(wrapper);
        elements.placeholderText.classList.add('hidden');
        elements.imagePreview.classList.remove('hidden');
        elements.deleteAll.classList.remove('hidden');
      } else {
        elements.placeholderText.classList.remove('hidden');
        elements.imagePreview.classList.add('hidden');
        elements.deleteAll.classList.add('hidden');
      }
      elements.crudModal.classList.remove('hidden');
      resetSelection();
    };

    const closeModal = () => {
      elements.crudModal.classList.add('hidden');
      resetSelection();
      elements.imagePreview.querySelectorAll('.aspect-square').forEach(el => {
        el.classList.remove('border-2', 'border-blue-500');
      });
    };

    const saveData = () => {
      const name = elements.nameInput.value.trim();
      const id = elements.editId.value;
      if (!name) {
        alert('Vui lòng nhập tên!');
        return;
      }

      if (state.modalMode === 'add') {
        const newId = state.data.length ? Math.max(...state.data.map(item => item.id)) + 1 : 1;
        state.data.push({ id: newId, name, image: 'https://robohash.org/default.png' });
        alert(`Đã thêm: ${name}`);
      } else {
        const index = state.data.findIndex(item => item.id == id);
        if (index !== -1) {
          state.data[index].name = name;
          alert(`Đã cập nhật: ${name}`);
        }
      }
      renderTable();
      closeModal();
    };

    const handleFileUpload = (files) => {
      const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
      if (!validFiles.length) return;

      elements.placeholderText.classList.add('hidden');
      elements.imagePreview.classList.remove('hidden');
      validFiles.forEach(file => {
        const blobURL = URL.createObjectURL(file);
        const wrapper = document.createElement('div');
        wrapper.className = 'relative aspect-square';
        const img = document.createElement('img');
        img.src = blobURL;
        img.className = 'h-full w-full rounded-lg object-cover cursor-pointer border-2';
        img.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openImageModal(blobURL);
        });

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '×';
        removeBtn.className = 'absolute top-2 right-2 bg-red-500 text-white rounded-md w-6 h-6 flex items-center justify-center';
        removeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          URL.revokeObjectURL(img.src);
          wrapper.remove();
          if (elements.imagePreview.children.length === 0) {
            elements.deleteAll.classList.add('hidden');
          }
        });

        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        elements.imagePreview.appendChild(wrapper);
      });

      if (elements.imagePreview.children.length > 0) {
        elements.deleteAll.classList.remove('hidden');
      }
    };

    const openImageModal = (src) => {
      elements.modalImage.src = src;
      elements.modalImage.classList.remove('hidden');
      elements.imageModal.classList.remove('hidden');
    };

    const closeImageModal = () => elements.imageModal.classList.add('hidden');

    const rotateImage = (deg) => { state.imageState.rotation += deg; updateTransform(); };
    const zoomImage = (factor) => { state.imageState.scale *= factor; updateTransform(); };
    const flipImage = () => { state.imageState.flipped = !state.imageState.flipped; updateTransform(); };
    const updateTransform = () => {
      const { rotation, scale, flipped } = state.imageState;
      elements.modalImage.style.transform = `scale(${flipped ? -scale : scale}, ${scale}) rotate(${rotation}deg)`;
    };

    const downloadTransformedImage = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        if (state.imageState.flipped) ctx.scale(-1, 1);
        ctx.rotate((state.imageState.rotation * Math.PI) / 180);
        ctx.scale(state.imageState.scale, state.imageState.scale);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        ctx.restore();
        const dataURI = canvas.toDataURL('image/png');
        const blob = dataURItoBlob(dataURI);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'transformed_image.png';
        a.click();
        URL.revokeObjectURL(url);
      };
      img.src = elements.modalImage.src;
    };

    let isSelecting = false;
    const selecto = new Selecto({
      container: document.body,
      selectableTargets: ['#imagePreview .aspect-square'],
      selectByClick: true,
      selectFromInside: false,
      continueSelect: true,
      hitRate: 0
    });

    let selectedElements = [];
    selecto.on('dragStart', (e) => {
      isSelecting = true;
      const target = e.inputEvent.target;
      if (target.tagName === 'BUTTON' || target.tagName === 'IMG') {
        e.stop();
      }
    });

    selecto.on('select', (e) => {
      e.removed.forEach(el => el.classList.remove('border-2', 'border-blue-500'));
      e.added.forEach(el => el.classList.add('border-2', 'border-blue-500'));
      selectedElements = e.selected;
      elements.deleteSelected.classList.toggle('hidden', selectedElements.length === 0);
    });

    selecto.on('dragEnd', (e) => {
      setTimeout(() => { 
        isSelecting = false; 
        elements.fileInput.disabled = false;
      }, 100);
    });

    elements.deleteSelected.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      selectedElements.forEach(el => {
        const img = el.querySelector('img');
        URL.revokeObjectURL(img.src);
        el.remove();
      });
      selectedElements = [];
      elements.deleteSelected.classList.add('hidden');
      if (elements.imagePreview.children.length === 0) {
        elements.deleteAll.classList.add('hidden');
      }
    });

    elements.deleteAll.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      Array.from(elements.imagePreview.children).forEach(wrapper => {
        const img = wrapper.querySelector('img');
        URL.revokeObjectURL(img.src);
      });
      elements.imagePreview.innerHTML = '';
      elements.placeholderText.classList.remove('hidden');
      elements.imagePreview.classList.add('hidden');
      resetSelection();
      elements.deleteAll.classList.add('hidden');
    });

    const resetSelection = () => {
      selectedElements.forEach(el => el.classList.remove('border-2', 'border-blue-500'));
      selectedElements = [];
      elements.deleteSelected.classList.add('hidden');
    };

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target.dataset.action === 'add') openModal('add');
      if (target.dataset.close || target.closest('[data-close]')) closeModal();
      if (target.id === 'closeImageModal') closeImageModal();
      if (target.dataset.edit) {
        const [id, name, image] = target.dataset.edit.split(',');
        openModal('edit', id, name, image);
      }
      if (target.dataset.rotate) rotateImage(parseInt(target.dataset.rotate));
      if (target.dataset.zoom) zoomImage(parseFloat(target.dataset.zoom));
      if (target.dataset.flip) flipImage();
      if (target.dataset.delete) {
        state.data = state.data.filter(item => item.id != target.dataset.delete);
        renderTable();
      }
      if (target.dataset.download) downloadTransformedImage();
    });

    elements.searchInput.addEventListener('input', debounce(() => {
      state.currentPage = 1;
      renderTable();
    }, 300));

    elements.dropzone.addEventListener('click', () => elements.fileInput.click());
    elements.fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files));
    elements.dropzone.addEventListener('dragover', (e) => e.preventDefault());
    elements.dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      if (!isSelecting) handleFileUpload(e.dataTransfer.files);
    });
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      elements.dropzoneOverlay.classList.remove('hidden');
    });
    document.addEventListener('dragleave', () => elements.dropzoneOverlay.classList.add('hidden'));
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      elements.dropzoneOverlay.classList.add('hidden');
      if (!isSelecting) handleFileUpload(e.dataTransfer.files);
    });
    elements.saveButton.addEventListener('click', saveData);

    window.onload = fetchData;
  </script>
</body>
</html>